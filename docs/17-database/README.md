# Розділ 17: Документація Бази Даних

## Вступ

Цей документ описує повну структуру бази даних для проєкту CRM4SMB. Архітектура розроблена з урахуванням трьох ключових принципів:

1.  **Безпека:** Дані кожного клієнта (організації) надійно ізольовані за допомогою механізму PostgreSQL **Row Level Security (RLS)**. Це унеможливлює доступ до чужих даних, навіть у випадку помилки в коді.
2.  **Продуктивність:** Для всіх таблиць створено оптимальні індекси, що гарантує швидке виконання запитів навіть при великих обсягах даних. Використовуються різні типи індексів для різних завдань: B-tree для звичайних полів, GIN для повнотекстового пошуку та масивів.
3.  **Масштабованість:** Гнучка структура з використанням `JSONB` для довільних полів дозволяє легко розширювати функціонал без необхідності змінювати структуру таблиць.

---

## 1. Перелічувані Типи (ENUMS)

ENUM — це спеціальний тип даних, який може приймати лише один зі списку можливих значень. Це забезпечує цілісність даних та економить місце.

*   `user_role`: Ролі користувачів (`owner`, `admin`, `manager`, `user`, `guest`).
*   `workspace_user_status`: Статус користувача в організації (`pending`, `active`, `suspended`).
*   `subscription_tier`: Тарифні плани (`free`, `starter`, `pro`, `enterprise`).
*   `subscription_status`: Статус підписки (`trialing`, `active`, `past_due`, `cancelled`).
*   `contact_status`: Статус контакту (`new`, `qualified`, `customer`, `lost`).
*   `company_status`: Статус компанії (`lead`, `active`, 'inactive').
*   `deal_status`: Статус угоди (`open`, `won`, `lost`, `cancelled`).
*   `task_type`: Типи завдань (`call`, `meeting`, `email`, `todo`).
*   `task_status`: Статуси завдань (`pending`, `in_progress`, `completed`, `cancelled`).
*   `task_priority`: Пріоритети завдань (`low`, `medium`, `high`).
*   `activity_type`: Типи подій у стрічці активності (`note`, `call`, `created` тощо).
*   `payment_status`: Статуси платежів (`pending`, `completed`, `failed`, `refunded`).

---

## 2. Структура Таблиць

Таблиці згруповані за логічними блоками для кращого розуміння.

### Ядро Системи (Хто і де працює)

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `workspaces` | "Акаунт" або "організація" вашого клієнта в системі. | `name` (назва), `slug` (унікальний ідентифікатор в URL), `owner_id` (хто власник). |
| `workspace_users` | Пов'язує користувачів з організаціями. | `workspace_id` (де працює), `user_id` (хто працює), `role` (яка роль). |

### Білінг та Підписки (Все, що стосується грошей)

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `subscriptions`| Підписка організації на тарифний план. | `tier` (тариф), `status` (статус підписки), `current_period_end` (дата наступної оплати). |
| `payments` | Історія всіх платежів по підписках. | `amount` (сума), `status` (статус платежу), `invoice_url` (посилання на інвойс). |
| `workspace_quotas`| **Лічильники та ліміти.** Зберігає ліміти тарифу (`max_contacts`) та поточне використання (`current_contacts`). Автоматично оновлюється тригерами для максимальної продуктивності. | `max_users`, `current_users`, `max_contacts`, `current_contacts` і т.д. |

### CRM-Сутності (Основні робочі інструменти)

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `contacts` | База контактів (фізичні особи). | `first_name`, `last_name`, `phones`, `emails`, `owner_id` (відповідальний менеджер). |
| `companies` | База компаній (юридичні особи). | `name` (назва), `edrpou` (ЄДРПОУ), `website`. |
| `deals` | Угоди або "продажі". | `title` (назва угоди), `amount` (сума), `pipeline_id` (в якій воронці), `stage_id` (на якому етапі). |
| `pipelines` | Воронки продажів. Це набір етапів, які проходить угода. | `name` (назва воронки), `stages` (JSON-масив з етапами). |
| `tasks` | Завдання для менеджерів. | `title` (назва), `due_date` (термін виконання), `assigned_to` (виконавець). |

### Товари та Послуги

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `products` | Каталог (прайс-лист) товарів та послуг. | `name` (назва), `price` (ціна), `sku` (артикул). |
| `product_categories`| Категорії для товарів для зручного групування. | `name`, `parent_id` (для створення ієрархії). |
| `deal_products` | Товари, додані до конкретної угоди. | `deal_id`, `product_id`, `quantity` (кількість), `price`, `discount`. |

### Історія та Аудит (Для аналітики та контролю)

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `activities` | **Стрічка активності.** Зберігає всю історію дій в системі: "Користувач А додав контакт Б". Дозволяє бачити повну хронологію роботи. | `activity_type`, `content` (опис дії), `user_id` (хто зробив). |
| `deal_stage_history`| Історія руху угоди по етапах воронки. Потрібна для аналітики продажів. | `deal_id`, `from_stage_id`, `to_stage_id`, `duration_seconds` (скільки часу угода була на етапі). |
| `product_price_history`| Історія зміни цін на товари для фінансового аудиту. | `product_id`, `old_price`, `new_price`, `changed_by` (хто змінив). |

### Допоміжні Таблиці

| Таблиця | Призначення | Ключові поля |
| :--- | :--- | :--- |
| `files` | Інформація про завантажені файли (договори, аватари). | `name`, `storage_path` (шлях у сховищі Supabase), `uploaded_by`. |
| `notifications` | Сповіщення для користувачів ("Вам призначено нове завдання"). | `user_id` (кому), `title`, `message`, `is_read` (прочитано чи ні). |
| `integrations` | Налаштування та API-ключі для інтеграцій (Нова Пошта, SMTP). | `nova_poshta_api_key`, `smtp_settings`. |

---

## 3. Автоматизація: Тригери та Функції

Тригери — це спеціальні процедури, які база даних автоматично виконує при настанні певних подій (наприклад, при додаванні нового запису).

*   `update_updated_at_column()`: Автоматично оновлює поле `updated_at` при будь-якій зміні запису в таблиці.
*   `update_deal_amount()`: Автоматично перераховує загальну суму угоди (`deals.amount`) щоразу, коли до неї додають, змінюють або видаляють товар (`deal_products`).
*   `update_workspace_usage()`: Автоматично оновлює лічильники використання (`current_contacts`, `current_deals`, `current_users`) в таблиці `workspace_quotas`.
*   `log_product_price_change()`: Записує стару та нову ціну в `product_price_history` при зміні ціни товару.
*   `create_default_pipeline()`: Автоматично створює воронку продажів та запис про квоти для нової організації.
*   **(Покращено)** `track_deal_stage_change()` та `log_initial_deal_stage()`: Ця пара тригерів працює разом для аналітики. Перший записує початковий етап угоди при її створенні. Другий при переході на новий етап обчислює, скільки часу угода провела в попередньому етапі, і записує це в `duration_seconds`.

Допоміжні функції `get_current_workspace_id()` та `get_current_user_role()` використовуються в політиках безпеки для отримання контексту поточного користувача.

---

## 4. Безпека: Row Level Security (RLS)

RLS — це потужний механізм PostgreSQL, який працює як "сторож" для кожного рядка в таблиці. Перед тим, як віддати або змінити дані, він перевіряє, чи має поточний користувач на це право.

**Як це працює у вашому проєкті:**

*   **Ізоляція організацій:** Головне правило для всіх таблиць — `workspace_id = get_current_workspace_id()`. Це означає, що користувач в принципі не може побачити дані, що не належать його організації.
*   **Розмежування за ролями:** Політики також перевіряють роль користувача. Наприклад, політика для перегляду угод може виглядати так (спрощено):
    *   **Адмін/Менеджер:** може бачити всі угоди своєї організації.
    *   **Звичайний користувач:** може бачити **тільки свої** угоди (де він вказаний як відповідальний `owner_id`).
*   **Захист від небезпечних операцій:** Наприклад, видалити користувача з організації (`workspace_users`) може тільки `admin` або `owner`.

Цей підхід гарантує, що навіть якщо в коді фронтенду буде помилка, база даних не дозволить виконати неавторизовану дію.

---

## 5. Оптимізація та Індекси

Індекси працюють як алфавітний покажчик у великій книзі: замість того, щоб гортати всі сторінки, ви одразу знаходите потрібну. У базі даних це дозволяє миттєво знаходити дані.

У схемі використовуються:
*   **Стандартні (B-Tree) індекси:** на всіх полях, за якими відбувається пошук або зв'язок (наприклад, `workspace_id`, `owner_id`, `status`).
*   **Часткові індекси:** наприклад, `WHERE deleted_at IS NULL`. Це означає, що в індекс потрапляють тільки активні (невидалені) записи. Це робить індекс меншим і ще швидшим.
*   **GIN-індекси:** спеціальні індекси для повнотекстового пошуку по імені контакту (`to_tsvector`) та для пошуку по тегах (які зберігаються в масиві).
