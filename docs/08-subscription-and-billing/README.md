# Розділ 8: Модель Підписки та Білінгу

Монетизація продукту базується на моделі щомісячної або щорічної підписки (SaaS) з різними тарифними планами. Кількість доступних воркспейсів, а також ліміти на користувачів та дані залежать від обраного тарифу.

## 8.1. Тарифні Плани

Тарифні плани розроблені для задоволення потреб бізнесу на різних етапах його розвитку.

| План | Орієнтовна ціна (UAH/міс) | Воркспейси | Користувачі | Контакти | Сховище | Ключові особливості |
|---|---|---|---|---|---|---|
| **Free** | 0 | 1 | 2 | 100 | 500 MB | Базовий функціонал CRM для одного проекту. |
| **Starter** | 299 | 5 | 5 | 5,000 | 5 GB | Все з "Free", пріоритетна підтримка, до 5 воркспейси. |
| **Pro** | 799 | 20 | 20 | 50,000 | 50 GB | Все з "Starter", плюс розширена аналітика, автоматизація та доступ до API. |
| **Enterprise** | Індивідуально | Необмежено | Необмежено | Необмежено | Все з "Pro", плюс White-label, персональний менеджер. |

### Платні модулі (Add-ons)

Замість створення великої кількості тарифних планів, ми пропонуємо гнучку систему "à la carte", що дозволяє клієнтам на тарифі "Starter" і вище докуповувати додаткові модулі за окрему щомісячну плату. Це дозволяє не перевантажувати базові тарифи та надавати вузькоспеціалізований функціонал тим, хто його потребує.

**Приклади модулів:**
*   **Складський облік:** ~150 грн/міс
*   **Поглиблена автоматизація (Workflows):** ~200 грн/міс
*   **Розширена інтеграція з Email/SMS:** ~100 грн/міс + вартість повідомлень
*   **Доступ до відкритого API:** ~250 грн/міс

Технічно, доступ до модулів буде керуватися через поле в таблиці `subscriptions`, де зберігатиметься список придбаних модулів для кожної організації. Інтерфейс буде динамічно відображати або приховувати відповідний функціонал.

## 8.2. Інтеграція з Платіжними Системами

Для обробки платежів та керування підписками буде інтегровано зовнішній платіжний шлюз.

*   **Основний вибір:** **Paddle**. Цей сервіс виступає як "Merchant of Record", що означає, що він бере на себе всі турботи щодо податків (включаючи ПДВ для міжнародних клієнтів) та комплаєнсу.
*   **Альтернативи для України:** **Fondy**, **WayForPay** можуть бути інтегровані для зручності локальних клієнтів.

**Процес оплати:**
1.  Адміністратор в налаштуваннях обирає план та переходить на сторінку оплати (Checkout Page), надану платіжним шлюзом.
2.  Після успішної оплати платіжний шлюз надсилає на наш сервер **вебхук** (webhook) з інформацією про подію (`subscription_created`, `payment_succeeded` тощо).
3.  Наш бекенд обробляє вебхук, перевіряє його достовірність та оновлює статус підписки для відповідної організації в базі даних.

## 8.3. Керування Лімітами (Quota Management)

Система автоматично відстежує використання ресурсів для кожного робочого простору для забезпечення дотримання лімітів тарифного плану.

**Технічна реалізація:**

1.  **Таблиця для відстеження квот:** Створюється таблиця `workspace_quotas`, де зберігаються поточні ліміти та використання для кожної організації.
    ```sql
    CREATE TABLE workspace_quotas (
      workspace_id UUID PRIMARY KEY REFERENCES workspaces(id),
      max_users INT NOT NULL DEFAULT 2,
      max_contacts INT NOT NULL DEFAULT 100,
      -- Поточне використання
      current_users INT DEFAULT 0,
      current_contacts INT DEFAULT 0,
      -- ... інші лічильники
      updated_at TIMESTAMPTZ DEFAULT NOW()
    );
    ```

2.  **Автоматичне оновлення лічильників:** За допомогою тригерів у базі даних, при додаванні або видаленні записів (контактів, угод), лічильники в `workspace_quotas` автоматично оновлюються.
    ```sql
    CREATE OR REPLACE FUNCTION update_workspace_usage()
    RETURNS TRIGGER AS $$
    BEGIN
      IF TG_TABLE_NAME = 'contacts' THEN
        IF TG_OP = 'INSERT' THEN
          UPDATE workspace_quotas SET current_contacts = current_contacts + 1 WHERE workspace_id = NEW.workspace_id;
        ELSIF TG_OP = 'DELETE' THEN
          UPDATE workspace_quotas SET current_contacts = current_contacts - 1 WHERE workspace_id = OLD.workspace_id;
        END IF;
      END IF;
      -- ... аналогічно для інших сутностей
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    ```

3.  **Перевірка квот на сервері:** Перед створенням нового запису Server Action перевіряє, чи не перевищено ліміт.
    ```typescript
    // Функція для перевірки квоти
    async function checkQuota(workspaceId: string, quotaType: 'contacts' | 'users') {
      const supabase = createServerClient();
      const { data: quota } = await supabase
        .from('workspace_quotas')
        .select('*')
        .eq('workspace_id', workspaceId)
        .single();
      
      if (!quota) return false;
      
      const limits = {
        contacts: quota.current_contacts >= quota.max_contacts,
        users: quota.current_users >= quota.max_users
      };
      
      if (limits[quotaType]) {
        // Якщо ліміт перевищено, повертаємо помилку
        return false;
      }
      return true;
    }
    ```

## 8.4. Логіка Оновлення та Пониження Тарифу

*   **Оновлення (Upgrade):** Відбувається миттєво. Після успішної оплати нові, вищі ліміти та додатковий функціонал стають доступними одразу.

*   **Пониження (Downgrade):** Це складніший процес, що базується на принципі **"ніколи не видаляти дані автоматично"**. Якщо після переходу на нижчий тариф організація перевищує його ліміти (наприклад, має 7 користувачів при ліміті 5), система застосовує "м'які" обмеження:
    *   **Ліміт на дані (контакти, угоди):** Створення нових записів блокується. Користувач бачить повідомлення "Досягнуто ліміт записів для вашого тарифу. Щоб додати нові, видаліть старі або оновіть тариф". При цьому всі існуючі дані залишаються доступними для перегляду та редагування.
    *   **Ліміт на користувачів:** Система не блокує "зайвих" користувачів автоматично. Замість цього, адміністратор бачить попередження "У вашій команді 7 користувачів, що перевищує ліміт тарифу (5). Будь ласка, деактивуйте 2 користувачів". Можливість запрошувати нових членів команди блокується.
    *   Перед підтвердженням пониження тарифу система завжди показує чітке попередження про всі наслідки та обмеження.

## 8.5. Модель Даних для Білінгу

```sql
-- Таблиця для керування підписками організацій
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  tier TEXT NOT NULL, -- 'free', 'starter', 'pro'
  status TEXT NOT NULL DEFAULT 'active', -- 'active', 'past_due', 'cancelled', 'trialing'
  enabled_modules TEXT[] DEFAULT '{}', -- Масив активованих платних модулів, напр: ['inventory', 'api_access']
  
  -- Інформація про білінг
  billing_period TEXT DEFAULT 'monthly', -- 'monthly', 'annual'
  current_period_start TIMESTAMPTZ NOT NULL,
  current_period_end TIMESTAMPTZ NOT NULL,
  cancelled_at TIMESTAMPTZ,
  
  -- Інформація від платіжного провайдера
  payment_provider TEXT, -- 'paddle', 'fondy'
  external_subscription_id TEXT, -- ID підписки в зовнішній системі
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблиця для історії платежів
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subscription_id UUID NOT NULL REFERENCES subscriptions(id),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  
  amount NUMERIC(10,2) NOT NULL,
  currency TEXT NOT NULL,
  status TEXT NOT NULL, -- 'pending', 'completed', 'failed', 'refunded'
  
  payment_provider TEXT NOT NULL,
  external_payment_id TEXT, -- ID платежу в зовнішній системі
  
  invoice_url TEXT, -- Посилання на інвойс/квитанцію
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);
```

## 8.6. План реалізації білінгу в MVP

Для MVP реалізація білінгу буде спрощеною, але закладе основи для повноцінної системи.

1.  **Вибір провайдера та налаштування:** Вибрати основного провайдера (напр., Paddle) та налаштувати в ньому продукти, що відповідають нашим тарифним планам.
2.  **Інтеграція Checkout:** Створити в інтерфейсі сторінку "Білінг", де адміністратор може обрати тариф. Кнопка "Оплатити" перенаправляє на сторінку оплати, згенеровану провайдером.
3.  **Створення обробника вебхуків:** Реалізувати захищений ендпоінт (`/api/webhooks/payment`) для прийому сповіщень від платіжної системи (про успішну оплату, скасування підписки тощо).
4.  **Оновлення статусу в БД:** Обробник вебхуків має оновлювати дані в таблицях `subscriptions` та `payments`.
5.  **Застосування логіки тарифів:** Система має перевіряти статус підписки та застосовувати відповідні ліміти (наприклад, блокувати створення нових контактів при перевищенні квоти).
6.  **Тестування:** Провести повне тестування циклу оплати в "пісочниці" (sandbox mode) платіжного провайдера.
